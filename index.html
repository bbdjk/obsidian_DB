<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>옵시디언 프로토콜 DB (폴더 기능)</title>
    <style>
        /* 기본 설정 */
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; background-color: #121212; color: #e0e0e0; display: flex; height: 100vh; overflow: hidden; }
        
        /* 레이아웃 */
        #sidebar { width: 300px; background-color: #1e1e1e; border-right: 1px solid #333; display: flex; flex-direction: column; }
        #main { flex: 1; padding: 20px; overflow-y: auto; background-color: #121212; position: relative; }

        /* 검색창 */
        .search-box { padding: 15px; border-bottom: 1px solid #333; }
        #searchInput { width: 100%; padding: 10px; background: #2c2c2c; border: 1px solid #444; color: #fff; border-radius: 4px; }

        /* 네비게이션 (접기/펼치기 스타일 추가) */
        #nav { flex: 1; overflow-y: auto; }
        
        .nav-category { 
            padding: 12px 15px; 
            font-weight: bold; 
            color: #888; 
            font-size: 0.85rem; 
            text-transform: uppercase; 
            margin-top: 5px; 
            cursor: pointer; /* 클릭 가능 표시 */
            display: flex;
            justify-content: space-between; /* 화살표 오른쪽 정렬 */
            align-items: center;
            background-color: #1e1e1e;
            user-select: none; /* 텍스트 선택 방지 */
        }
        .nav-category:hover { color: #ccc; background-color: #252525; }
        
        /* 화살표 아이콘 */
        .arrow { transition: transform 0.2s ease; font-size: 0.7rem; }
        .arrow.collapsed { transform: rotate(-90deg); } /* 접혔을 때 회전 */

        /* 아이템 목록 컨테이너 */
        .nav-group-container { display: block; }
        .nav-group-container.collapsed { display: none; } /* 접히면 숨김 */

        .nav-item { padding: 10px 15px 10px 25px; /* 들여쓰기 */ cursor: pointer; border-left: 3px solid transparent; transition: 0.2s; font-size: 0.95rem; }
        .nav-item:hover { background-color: #2a2a2a; }
        .nav-item.active { background-color: #252525; border-left-color: #ffb74d; color: #ffb74d; }

        /* 콘텐츠 영역 */
        .content-card { max-width: 800px; margin: 0 auto; }
        .sub-title { color: #888; font-size: 1.1rem; margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; margin-bottom: 25px; background: #1e1e1e; padding: 15px; border-radius: 8px; }
        .stat-item { text-align: center; }
        .stat-val { font-size: 1.2rem; font-weight: bold; margin-top: 5px; color: #fff; }
        .detail-block { margin-bottom: 20px; padding: 15px; background: #1e1e1e; border-radius: 8px; border: 1px solid #333; }
        .detail-block h3 { margin: 0 0 10px 0; color: #ffb74d; font-size: 1.1rem; }
        .detail-block p { margin: 0; line-height: 1.6; color: #ccc; }
        
        .error-msg { color: #ff5252; padding: 10px; border: 1px solid #ff5252; margin: 10px; border-radius: 5px; background: rgba(255,82,82,0.1); }
        
        @media (max-width: 768px) {
            body { flex-direction: column; }
            #sidebar { width: 100%; height: 40%; }
            #main { height: 60%; }
        }

        /* =========================
           사이드바 접힘(기본) + 토글
        ========================= */
        #sidebar { flex: 0 0 300px; transition: transform 0.18s ease, width 0.18s ease, flex-basis 0.18s ease; }
        body.sidebar-collapsed #sidebar {
            width: 0;
            flex-basis: 0;
            border-right: none;
            transform: translateX(-100%);
            pointer-events: none;
        }
        body.sidebar-collapsed #sidebar * { opacity: 0; }
        #sidebarToggle {
            position: fixed;
            top: 12px;
            left: 312px; /* 사이드바(300) + 여백 */
            z-index: 9999;
            background: #2c2c2c;
            border: 1px solid #444;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            line-height: 1;
            user-select: none;
        }
        body.sidebar-collapsed #sidebarToggle { left: 12px; }

        /* =========================
           검색 결과 UI
        ========================= */
        .search-header { max-width: 900px; margin: 0 auto 12px auto; color: #bbb; }
        .search-list { max-width: 900px; margin: 0 auto; display: grid; gap: 10px; }
        .search-item-card {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 14px;
            cursor: pointer;
            transition: 0.15s;
        }
        .search-item-card:hover { transform: translateY(-1px); border-color: #555; }
        .search-item-title { font-size: 1.05rem; font-weight: 700; color: #fff; margin-bottom: 4px; }
        .search-item-meta { font-size: 0.85rem; color: #888; margin-bottom: 8px; }
        .search-item-excerpt { color: #cfcfcf; line-height: 1.55; }
        mark { background: rgba(255,183,77,0.25); color: #ffb74d; padding: 0 2px; border-radius: 3px; }

        @media (max-width: 768px) {
            #sidebarToggle { left: 12px; top: 8px; }
            body.sidebar-collapsed #sidebar { transform: translateY(-100%); } /* 모바일(상단 사이드바) 대응 */
        }

    </style>
</head>
<body>

<button id="sidebarToggle" aria-label="사이드바 토글" aria-expanded="false">☰</button>

<div id="sidebar">
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="검색...">
    </div>
    <div id="file-status" style="font-size:0.7rem; padding:5px 15px; color:#666;"></div>
    <div id="nav"></div>
</div>

<div id="main">
    <div style="text-align:center; color:#666; margin-top:50px;">
        <h2>데이터베이스 준비 완료</h2>
        <p>왼쪽 목록에서 항목을 선택하세요.</p>
        <div id="error-container"></div>
    </div>
</div>

<script src="db_rule.js" onerror="logError('db_rule.js')"></script>
<script src="db_faq.js" onerror="logError('db_faq.js')"></script>
<script src="db_rdl.js" onerror="logError('db_rdl.js')"></script>
<script src="db_un.js" onerror="logError('db_un.js')"></script>
<script src="db_gof.js" onerror="logError('db_gof.js')"></script>
<script src="db_pd.js" onerror="logError('db_pd.js')"></script>

<script>
    // 에러 로깅용
    const statusDiv = document.getElementById('file-status');
    const errorContainer = document.getElementById('error-container');
    let loadErrors = [];

    function logError(fileName) {
        loadErrors.push(fileName);
        const msg = `<div class="error-msg">⚠️ <b>${fileName}</b> 로드 실패!<br>Live Server를 사용해주세요.</div>`;
        errorContainer.innerHTML += msg;
    }

    // 데이터 통합 (안전 장치 포함)
    const DATABASE = [
        ...(typeof DATA_RULE !== 'undefined' ? DATA_RULE : []),
        ...(typeof DATA_FAQ  !== 'undefined' ? DATA_FAQ  : []),
        ...(typeof DATA_RDL  !== 'undefined' ? DATA_RDL  : []),
        ...(typeof DATA_UN   !== 'undefined' ? DATA_UN   : []),
        ...(typeof DATA_GOF  !== 'undefined' ? DATA_GOF  : []),
        ...(typeof DATA_PD   !== 'undefined' ? DATA_PD   : [])
    ];

    // 로드 상태 표시
    if(loadErrors.length === 0) {
        statusDiv.innerHTML = "✅ 시스템 정상 작동 중";
        statusDiv.style.color = "#4caf50";
    } else {
        statusDiv.innerHTML = `❌ ${loadErrors.length}개 파일 오류`;
        statusDiv.style.color = "#ff5252";
    }

    const nav = document.getElementById('nav');
    const main = document.getElementById('main');
    const searchInput = document.getElementById('searchInput');

    const NAV_ITEM_MAP = new Map();

    // ==========================================
    // [핵심 변경] 접기/펼치기 기능이 포함된 렌더링 함수
    // ==========================================
    function renderNav(list, isSearch = false) {
        nav.innerHTML = '';
        NAV_ITEM_MAP.clear();
        if(list.length === 0) {
            nav.innerHTML = '<div style="padding:15px; color:#666;">검색 결과가 없습니다.</div>';
            return;
        }

        const grouped = {};
        list.forEach(item => {
            const cat = item.cat || 'Others';
            if(!grouped[cat]) grouped[cat] = [];
            grouped[cat].push(item);
        });

        // 카테고리별 루프
        for (const [catName, items] of Object.entries(grouped)) {
            // 1. 카테고리 헤더 생성
            const catHeader = document.createElement('div');
            catHeader.className = 'nav-category';
            catHeader.innerHTML = `<span>${catName}</span> <span class="arrow">▼</span>`;
            
            // 2. 아이템 담을 컨테이너 생성
            const groupContainer = document.createElement('div');
            groupContainer.className = 'nav-group-container';

            // 3. 각 아이템 생성
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'nav-item';
                div.textContent = item.title;
                div.dataset.itemId = item.id || '';
                if(item.id) NAV_ITEM_MAP.set(item.id, div);

                div.onclick = () => {
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                    div.classList.add('active');
                    showDetail(item);
                };
                groupContainer.appendChild(div);
            });

            // 4. 클릭 이벤트 (접기/펴기)
            catHeader.onclick = () => {
                groupContainer.classList.toggle('collapsed'); // 목록 숨김 토글
                catHeader.querySelector('.arrow').classList.toggle('collapsed'); // 화살표 회전 토글
            };

            // [추가 기능] 검색 중일 때는 모든 카테고리를 강제로 펼쳐둠
            if(isSearch) {
                groupContainer.classList.remove('collapsed');
            }

            nav.appendChild(catHeader);
            nav.appendChild(groupContainer);
        }
    }

    function showDetail(item) {
        let html = `<div class="content-card fade-in">
                    <div style="margin-bottom:20px;">
                        <h1 style="color:${getColor(item.color)}">${item.title}</h1>
                        <div class="sub-title">${item.sub || item.cat}</div>
                    </div>`;

        if(item.stats) {
            html += `<div class="stats-grid">`;
            for(let [k,v] of Object.entries(item.stats)) 
                html += `<div class="stat-item"><span style="color:#666;font-size:0.8rem;">${k}</span><div class="stat-val">${v}</div></div>`;
            html += `</div>`;
        }

        if(item.data) { 
            if(item.desc) html += `<p style="color:#aaa; margin-bottom:20px;">${item.desc}</p>`;
            item.data.forEach(d => {
                let qText = d.q.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                let aText = d.a.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                html += `<div class="detail-block">
                            <h3 style="color:#fff;">Q. ${qText}</h3>
                            <p style="color:#bbb; margin-top:5px;">A. ${aText}</p>
                         </div>`;
            });
        } else if(item.details) {
            item.details.forEach(d => {
                let tText = d.t.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                html += `<div class="detail-block"><h3>${d.h}</h3><p>${tText}</p></div>`;
            });
        }
        
        html += `</div>`;
        main.innerHTML = html;
        if(window.innerWidth <= 768) main.scrollTop = 0;
    }

    function getColor(code) {
        if(code === 'rdl') return '#ff5252';
        if(code === 'un') return '#448aff';
        if(code === 'gof') return '#69f0ae';
        if(code === 'pd') return '#e040fb';
        return '#e0e0e0';
    }

    
    // --------------------------
    // 사이드바 토글 (첫 진입: 기본 접힘)
    // --------------------------
    const DEFAULT_MAIN_HTML = main.innerHTML;
    const SIDEBAR_STATE_KEY = "op_sidebar_collapsed";
    let sidebarCollapsed = (() => {
        const v = localStorage.getItem(SIDEBAR_STATE_KEY);
        return v == null ? true : v === "true";
    })();

    function applySidebarState() {
        document.body.classList.toggle("sidebar-collapsed", sidebarCollapsed);
        const btn = document.getElementById("sidebarToggle");
        if(btn) btn.setAttribute("aria-expanded", String(!sidebarCollapsed));
        localStorage.setItem(SIDEBAR_STATE_KEY, String(sidebarCollapsed));
    }

    document.getElementById("sidebarToggle")?.addEventListener("click", () => {
        sidebarCollapsed = !sidebarCollapsed;
        applySidebarState();
    });

    applySidebarState();

    // --------------------------
    // 전체 DB 통합 검색 (오른쪽에 결과 표시)
    // --------------------------
    function stripHtml(input) {
        if(!input) return "";
        const doc = new DOMParser().parseFromString(String(input), "text/html");
        return (doc.body?.textContent || "").replace(/\s+/g, " ").trim();
    }

    function buildSearchText(item) {
        const parts = [];
        parts.push(item.title || "");
        parts.push(item.cat || "");
        parts.push(item.sub || "");
        if(item.desc) parts.push(item.desc);

        if(item.stats) {
            for(const [k,v] of Object.entries(item.stats)) parts.push(`${k} ${v}`);
        }

        if(Array.isArray(item.details)) {
            item.details.forEach(d => {
                parts.push(stripHtml(d.h));
                parts.push(stripHtml(d.t));
            });
        }

        if(Array.isArray(item.data)) { // FAQ
            item.data.forEach(d => {
                parts.push(d.q || "");
                parts.push(d.a || "");
            });
        }

        return parts.join(" ").replace(/\s+/g, " ").trim();
    }

    const SEARCH_INDEX = DATABASE.map(item => {
        const text = buildSearchText(item);
        return { item, text, lc: text.toLowerCase() };
    });

    function escapeHtml(s) {
        return String(s)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
    }

    function highlightHtml(text, qTokens) {
        let out = escapeHtml(text);
        qTokens.forEach(tok => {
            if(!tok) return;
            const re = new RegExp(`(${tok.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")})`, "ig");
            out = out.replace(re, "<mark>$1</mark>");
        });
        return out;
    }

    function makeExcerpt(fullText, qTokens, radius = 80) {
        const t = fullText || "";
        const tl = t.toLowerCase();
        let idx = -1;
        for(const tok of qTokens) {
            const i = tl.indexOf(tok);
            if(i >= 0) { idx = i; break; }
        }
        if(idx < 0) return t.slice(0, 220);

        const start = Math.max(0, idx - radius);
        const end = Math.min(t.length, idx + qTokens[0].length + radius);
        const prefix = start > 0 ? "…" : "";
        const suffix = end < t.length ? "…" : "";
        return (prefix + t.slice(start, end) + suffix).replace(/\s+/g, " ").trim();
    }

    function setActiveNavById(id) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const el = NAV_ITEM_MAP.get(id);
        if(el) {
            el.classList.add('active');
            el.scrollIntoView({ block: "nearest" });
        }
    }

    function renderSearchResults(query, results) {
        const qTokens = query.toLowerCase().split(/\s+/).filter(Boolean);

        const header = `
            <div class="search-header">
                검색어: <b>${escapeHtml(query)}</b> · 결과: <b>${results.length}</b>개
            </div>
        `;

        const cards = results.map(({item, text}) => {
            const excerpt = makeExcerpt(text, qTokens);
            return `
                <div class="search-item-card" data-id="${escapeHtml(item.id || '')}">
                    <div class="search-item-title" style="color:${getColor(item.color)}">${highlightHtml(item.title || "", qTokens)}</div>
                    <div class="search-item-meta">${escapeHtml(item.cat || "")}${item.sub ? " · " + escapeHtml(item.sub) : ""}</div>
                    <div class="search-item-excerpt">${highlightHtml(excerpt, qTokens)}</div>
                </div>
            `;
        }).join("");

        main.innerHTML = header + `<div class="search-list">${cards}</div>`;

        main.querySelectorAll(".search-item-card").forEach(card => {
            card.addEventListener("click", () => {
                const id = card.getAttribute("data-id");
                const found = DATABASE.find(x => (x.id || "") === id);
                if(found) {
                    showDetail(found);
                    if(id) setActiveNavById(id);
                }
            });
        });

        if(window.innerWidth <= 768) main.scrollTop = 0;
    }

    function searchAll(keywordRaw) {
        const keyword = (keywordRaw || "").trim();
        if(!keyword) {
            main.innerHTML = DEFAULT_MAIN_HTML;
            return;
        }

        const tokens = keyword.toLowerCase().split(/\s+/).filter(Boolean);
        const results = SEARCH_INDEX.filter(x => tokens.every(t => x.lc.includes(t)));

        renderSearchResults(keyword, results);
    }

    searchInput.addEventListener('input', (e) => {
        searchAll(e.target.value);
    });

    renderNav(DATABASE);

</script>
</body>
</html>
