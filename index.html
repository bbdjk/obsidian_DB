<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>옵시디언 프로토콜 DB (폴더 기능)</title>
    <style>
        /* 기본 설정 */
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; background-color: #121212; color: #e0e0e0; display: flex; height: 100vh; overflow: hidden; }
        
        /* 레이아웃 */
        #sidebar { width: 300px; background-color: #1e1e1e; border-right: 1px solid #333; display: flex; flex-direction: column; }
        #main { flex: 1; padding: 20px; overflow-y: auto; background-color: #121212; position: relative; }

        /* 검색창 */
        .search-box { padding: 15px; border-bottom: 1px solid #333; }
        #searchInput { width: 100%; padding: 10px; background: #2c2c2c; border: 1px solid #444; color: #fff; border-radius: 4px; }

        /* 네비게이션 (접기/펼치기 스타일 추가) */
        #nav { flex: 1; overflow-y: auto; }
        
        .nav-category { 
            padding: 12px 15px; 
            font-weight: bold; 
            color: #888; 
            font-size: 0.85rem; 
            text-transform: uppercase; 
            margin-top: 5px; 
            cursor: pointer; /* 클릭 가능 표시 */
            display: flex;
            justify-content: space-between; /* 화살표 오른쪽 정렬 */
            align-items: center;
            background-color: #1e1e1e;
            user-select: none; /* 텍스트 선택 방지 */
        }
        .nav-category:hover { color: #ccc; background-color: #252525; }
        
        /* 화살표 아이콘 (기본: 접힘 ▶, 펼침: 회전) */
        .arrow { transition: transform 0.2s ease; font-size: 0.7rem; transform: rotate(0deg); }
        .arrow.expanded { transform: rotate(90deg); }

        /* 아이템 목록 컨테이너 */
        .nav-group-container { display: block; }
        .nav-group-container.collapsed { display: none; } /* 접히면 숨김 */

        .nav-item { padding: 10px 15px 10px 25px; /* 들여쓰기 */ cursor: pointer; border-left: 3px solid transparent; transition: 0.2s; font-size: 0.95rem; }
        .nav-item:hover { background-color: #2a2a2a; }
        .nav-item.active { background-color: #252525; border-left-color: #ffb74d; color: #ffb74d; }

        /* 콘텐츠 영역 */
        .content-card { max-width: 800px; margin: 0 auto; }
        .sub-title { color: #888; font-size: 1.1rem; margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; margin-bottom: 25px; background: #1e1e1e; padding: 15px; border-radius: 8px; }
        .stat-item { text-align: center; }
        .stat-val { font-size: 1.2rem; font-weight: bold; margin-top: 5px; color: #fff; }
        .detail-block { margin-bottom: 20px; padding: 15px; background: #1e1e1e; border-radius: 8px; border: 1px solid #333; }
        .detail-block h3 { margin: 0 0 10px 0; color: #ffb74d; font-size: 1.1rem; }
        .detail-block p { margin: 0; line-height: 1.6; color: #ccc; }
        
        .error-msg { color: #ff5252; padding: 10px; border: 1px solid #ff5252; margin: 10px; border-radius: 5px; background: rgba(255,82,82,0.1); }
        
        /* 검색 결과 */
        .search-results { max-width: 900px; margin: 0 auto; }
        .search-header { color:#888; margin: 10px 0 18px 0; }
        .search-result { padding: 14px; background:#1e1e1e; border:1px solid #333; border-radius: 8px; margin-bottom: 10px; cursor: pointer; }
        .search-result:hover { background:#252525; }
        .search-result-title { font-size: 1.05rem; font-weight: 700; margin: 0 0 6px 0; color:#fff; }
        .search-result-meta { font-size: 0.85rem; color:#888; margin-bottom: 8px; }
        .search-result-excerpt { color:#bbb; line-height: 1.5; }
        mark { background: rgba(255,183,77,0.25); color:#ffb74d; padding:0 2px; border-radius:3px; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            #sidebar { width: 100%; height: 40%; }
            #main { height: 60%; }
        }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="검색...">
    </div>
    <div id="file-status" style="font-size:0.7rem; padding:5px 15px; color:#666;"></div>
    <div id="nav"></div>
</div>

<div id="main">
    <div style="text-align:center; color:#666; margin-top:50px;">
        <h2>데이터베이스 준비 완료</h2>
        <p>왼쪽 목록에서 항목을 선택하세요.</p>
        <div id="error-container"></div>
    </div>
</div>

<script src="db_rule.js" onerror="logError('db_rule.js')"></script>
<script src="db_faq.js" onerror="logError('db_faq.js')"></script>
<script src="db_rdl.js" onerror="logError('db_rdl.js')"></script>
<script src="db_un.js" onerror="logError('db_un.js')"></script>
<script src="db_gof.js" onerror="logError('db_gof.js')"></script>
<script src="db_pd.js" onerror="logError('db_pd.js')"></script>

<script>
    // 에러 로깅용
    const statusDiv = document.getElementById('file-status');
    const errorContainer = document.getElementById('error-container');
    let loadErrors = [];

    function logError(fileName) {
        loadErrors.push(fileName);
        const msg = `<div class="error-msg">⚠️ <b>${fileName}</b> 로드 실패!<br>Live Server를 사용해주세요.</div>`;
        errorContainer.innerHTML += msg;
    }

    // 데이터 통합 (안전 장치 포함)
    const DATABASE = [
        ...(typeof DATA_RULE !== 'undefined' ? DATA_RULE : []),
        ...(typeof DATA_FAQ  !== 'undefined' ? DATA_FAQ  : []),
        ...(typeof DATA_RDL  !== 'undefined' ? DATA_RDL  : []),
        ...(typeof DATA_UN   !== 'undefined' ? DATA_UN   : []),
        ...(typeof DATA_GOF  !== 'undefined' ? DATA_GOF  : []),
        ...(typeof DATA_PD   !== 'undefined' ? DATA_PD   : [])
    ];

    // 로드 상태 표시
    if(loadErrors.length === 0) {
        statusDiv.innerHTML = "✅ 시스템 정상 작동 중";
        statusDiv.style.color = "#4caf50";
    } else {
        statusDiv.innerHTML = `❌ ${loadErrors.length}개 파일 오류`;
        statusDiv.style.color = "#ff5252";
    }

    const nav = document.getElementById('nav');

    const main = document.getElementById('main');
    const searchInput = document.getElementById('searchInput');

    // ----------------------------
    // 유틸
    // ----------------------------
    function getColor(code) {
        if(code === 'rdl') return '#ff5252';
        if(code === 'un')  return '#448aff';
        if(code === 'gof') return '#69f0ae';
        if(code === 'pd')  return '#e040fb';
        return '#e0e0e0';
    }

    function escapeHtml(s) {
        return String(s)
            .replaceAll('&','&amp;')
            .replaceAll('<','&lt;')
            .replaceAll('>','&gt;')
            .replaceAll('"','&quot;')
            .replaceAll("'","&#039;");
    }

    function cssEsc(s) {
        try { return (window.CSS && CSS.escape) ? CSS.escape(String(s)) : String(s).replace(/["\\]/g, '\\$&'); }
        catch { return String(s).replace(/["\\]/g, '\\$&'); }
    }

    function makeKey(item) {
        const cat = item.cat || 'Others';
        const title = item.title || '';
        return encodeURIComponent(cat + '|' + title);
    }

    function stripToText(html) {
        if(!html) return '';
        const doc = new DOMParser().parseFromString(String(html), 'text/html');
        return (doc.body?.textContent || '').replace(/\s+/g,' ').trim();
    }

    function itemToSearchText(item) {
        const parts = [];
        if(item.title) parts.push(item.title);
        if(item.cat)   parts.push(item.cat);
        if(item.sub)   parts.push(item.sub);
        if(item.desc)  parts.push(stripToText(item.desc));

        if(item.stats) {
            for(const [k,v] of Object.entries(item.stats)) parts.push(`${k} ${v}`);
        }

        if(Array.isArray(item.details)) {
            item.details.forEach(d => {
                if(d?.h) parts.push(d.h);
                if(d?.t) parts.push(stripToText(d.t));
            });
        }

        // FAQ 형태: data = [{q,a}, ...]
        if(Array.isArray(item.data)) {
            if(item.desc) parts.push(stripToText(item.desc));
            item.data.forEach(d => {
                if(d?.q) parts.push(stripToText(d.q));
                if(d?.a) parts.push(stripToText(d.a));
            });
        }

        return parts.join('\n');
    }

    
function parseCategory(catRaw) {
    const cat = (catRaw || 'Others').trim();
    // UN 하위 카테고리: "UN - xxx" 형태를 "UN" 상위 + "xxx" 하위로 분리
    const m = /^UN\s*-\s*(.+)$/.exec(cat);
    if(m) return { parent: 'UN', child: m[1].trim(), full: cat };
    return { parent: cat, child: null, full: cat };
}

function formatCategoryLabel(catRaw) {
    const p = parseCategory(catRaw);
    return p.child ? `${p.parent} > ${p.child}` : p.parent;
}

function highlightHtml(text, keyword) {
        if(!keyword) return escapeHtml(text);
        const safe = escapeHtml(text);
        const re = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'ig');
        return safe.replace(re, '<mark>$1</mark>');
    }

    function excerpt(text, keyword, radius = 70) {
        const t = text || '';
        const lt = t.toLowerCase();
        const k = (keyword || '').toLowerCase();
        const i = lt.indexOf(k);
        if(i < 0) return t.slice(0, 180);
        const start = Math.max(0, i - radius);
        const end = Math.min(t.length, i + k.length + radius);
        return (start > 0 ? '…' : '') + t.slice(start, end) + (end < t.length ? '…' : '');
    }

    function showHome() {
        main.innerHTML = `
            <div style="text-align:center; color:#666; margin-top:50px;">
                <h2>데이터베이스 준비 완료</h2>
                <p>왼쪽 목록에서 항목을 선택하세요.</p>
                <div id="error-container"></div>
            </div>
        `;
        const homeErr = main.querySelector('#error-container');
        if(homeErr && window.__OP_LOAD_ERRORS_HTML__) homeErr.innerHTML = window.__OP_LOAD_ERRORS_HTML__;
    }

    
// ----------------------------
// 왼쪽 네비: 기본 접힘 + UN 2단 폴더
// ----------------------------
function renderNav(list) {
    nav.innerHTML = '';
    if(list.length === 0) {
        nav.innerHTML = '<div style="padding:15px; color:#666;">데이터가 없습니다.</div>';
        return;
    }

    // parent -> { __items:[], children:{childName:[]} }
    const grouped = new Map();

    list.forEach(item => {
        const p = parseCategory(item.cat);
        if(!grouped.has(p.parent)) grouped.set(p.parent, { __items: [], children: new Map() });

        const bucket = grouped.get(p.parent);
        if(p.child) {
            if(!bucket.children.has(p.child)) bucket.children.set(p.child, []);
            bucket.children.get(p.child).push(item);
        } else {
            bucket.__items.push(item);
        }
    });

    for (const [parentName, bucket] of grouped.entries()) {
        // 상위 카테고리 헤더
        const parentHeader = document.createElement('div');
        parentHeader.className = 'nav-category';
        parentHeader.dataset.parent = parentName;
        parentHeader.innerHTML = `<span>${escapeHtml(parentName)}</span> <span class="arrow">▶</span>`;

        const parentContainer = document.createElement('div');
        parentContainer.className = 'nav-group-container collapsed';
        parentContainer.dataset.parent = parentName;

        // 일반(1단) 카테고리 아이템
        bucket.__items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'nav-item';
            div.textContent = item.title;
            div.dataset.key = makeKey(item);
            div.dataset.parent = parentName;
            div.dataset.child = '';

            div.onclick = () => {
                activateNavByKey(div.dataset.key);
                showDetail(item);
                if(window.innerWidth <= 768) main.scrollTop = 0;
            };
            parentContainer.appendChild(div);
        });

        // UN 같은 2단 구조(하위 카테고리)
        for (const [childName, items] of bucket.children.entries()) {
            const childHeader = document.createElement('div');
            childHeader.className = 'nav-subcategory';
            childHeader.dataset.parent = parentName;
            childHeader.dataset.child = childName;
            childHeader.innerHTML = `<span>${escapeHtml(childName)}</span> <span class="arrow">▶</span>`;

            const childContainer = document.createElement('div');
            childContainer.className = 'nav-subgroup-container collapsed';
            childContainer.dataset.parent = parentName;
            childContainer.dataset.child = childName;

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'nav-item';
                div.textContent = item.title;
                div.dataset.key = makeKey(item);
                div.dataset.parent = parentName;
                div.dataset.child = childName;

                div.onclick = () => {
                    activateNavByKey(div.dataset.key);
                    showDetail(item);
                    if(window.innerWidth <= 768) main.scrollTop = 0;
                };

                childContainer.appendChild(div);
            });

            childHeader.onclick = () => {
                const isCollapsed = childContainer.classList.contains('collapsed');
                if(isCollapsed) {
                    childContainer.classList.remove('collapsed');
                    childHeader.querySelector('.arrow')?.classList.add('expanded');
                } else {
                    childContainer.classList.add('collapsed');
                    childHeader.querySelector('.arrow')?.classList.remove('expanded');
                }
            };

            parentContainer.appendChild(childHeader);
            parentContainer.appendChild(childContainer);
        }

        parentHeader.onclick = () => {
            const isCollapsed = parentContainer.classList.contains('collapsed');
            if(isCollapsed) {
                parentContainer.classList.remove('collapsed');
                parentHeader.querySelector('.arrow')?.classList.add('expanded');
            } else {
                parentContainer.classList.add('collapsed');
                parentHeader.querySelector('.arrow')?.classList.remove('expanded');

                // 상위 접힘 시 하위도 모두 접기(정리)
                parentContainer.querySelectorAll('.nav-subgroup-container').forEach(el => el.classList.add('collapsed'));
                parentContainer.querySelectorAll('.nav-subcategory .arrow').forEach(a => a.classList.remove('expanded'));
            }
        };

        nav.appendChild(parentHeader);
        nav.appendChild(parentContainer);
    }
}

function expandParent(parentName) {
    const sel = cssEsc(parentName);
    const group = nav.querySelector(`.nav-group-container[data-parent="${sel}"]`);
    const header = nav.querySelector(`.nav-category[data-parent="${sel}"]`);
    if(group && header) {
        group.classList.remove('collapsed');
        header.querySelector('.arrow')?.classList.add('expanded');
    }
}

function expandChild(parentName, childName) {
    const p = cssEsc(parentName);
    const c = cssEsc(childName);
    const group = nav.querySelector(`.nav-subgroup-container[data-parent="${p}"][data-child="${c}"]`);
    const header = nav.querySelector(`.nav-subcategory[data-parent="${p}"][data-child="${c}"]`);
    if(group && header) {
        group.classList.remove('collapsed');
        header.querySelector('.arrow')?.classList.add('expanded');
    }
}

function activateNavByKey(key) {
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    const el = nav.querySelector(`.nav-item[data-key="${cssEsc(key)}"]`);
    if(el) {
        el.classList.add('active');

        const parentName = el.dataset.parent || (el.dataset.cat || 'Others');
        const childName = el.dataset.child || '';

        expandParent(parentName);
        if(childName) expandChild(parentName, childName);

        el.scrollIntoView({ block: 'nearest' });
    }
}

    // ----------------------------
    // 상세 보기 (기존 로직 유지)
    // ----------------------------
    function showDetail(item) {
        let html = `<div class="content-card fade-in">
                    <div style="margin-bottom:20px;">
                        <h1 style="color:${getColor(item.color)}">${escapeHtml(item.title)}</h1>
                        <div class="sub-title">${escapeHtml(item.sub || item.cat || '')}</div>
                    </div>`;

        if(item.stats) {
            html += `<div class="stats-grid">`;
            for(let [k,v] of Object.entries(item.stats)) {
                html += `<div class="stat-item"><span style="color:#666;font-size:0.8rem;">${escapeHtml(k)}</span><div class="stat-val">${escapeHtml(v)}</div></div>`;
            }
            html += `</div>`;
        }

        if(item.data) {
            if(item.desc) html += `<p style="color:#aaa; margin-bottom:20px;">${item.desc}</p>`;
            item.data.forEach(d => {
                let qText = String(d.q || '').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                let aText = String(d.a || '').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                html += `<div class="detail-block">
                            <h3 style="color:#fff;">Q. ${qText}</h3>
                            <p style="color:#bbb; margin-top:5px;">A. ${aText}</p>
                         </div>`;
            });
        } else if(item.details) {
            item.details.forEach(d => {
                let tText = String(d.t || '').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                html += `<div class="detail-block"><h3>${escapeHtml(d.h || '')}</h3><p>${tText}</p></div>`;
            });
        }

        html += `</div>`;
        main.innerHTML = html;
    }

    // ----------------------------
    // 통합 검색: 전체 내용 검색 → 오른쪽에 결과 출력
    // ----------------------------
    
let SEARCH_INDEX = [];
function buildSearchIndex() {
    SEARCH_INDEX = DATABASE.map(item => {
        const p = parseCategory(item.cat);
        return {
            item,
            key: makeKey(item),
            parent: p.parent,
            child: p.child || '',
            catLabel: formatCategoryLabel(item.cat),
            title: item.title || '',
            text: itemToSearchText(item),
            lc: '' // lazy
        };
    });
}

    function renderSearchResults(keyword, results) {
        const k = keyword.trim();
        if(!k) { showHome(); return; }

        const cards = results.map(r => {
            const ex = excerpt(r.text, k);
            return `
                <div class="search-result" data-k="${r.key}">
                    <div class="search-result-title">${highlightHtml(r.title, k)}</div>
                    <div class="search-result-meta">${escapeHtml(r.catLabel)}</div>
                    <div class="search-result-excerpt">${highlightHtml(ex, k)}</div>
                </div>
            `;
        }).join('');

        main.innerHTML = `
            <div class="search-results">
                <div class="search-header">검색어: <b>${escapeHtml(k)}</b> / 결과: ${results.length}개</div>
                ${cards || '<div style="color:#666; padding:10px 0;">검색 결과가 없습니다.</div>'}
            </div>
        `;

        main.querySelectorAll('.search-result').forEach(el => {
            el.addEventListener('click', () => {
                const key = el.getAttribute('data-k');
                const rec = SEARCH_INDEX.find(x => x.key === key);
                if(!rec) return;
                activateNavByKey(key);
                showDetail(rec.item);
            });
        });
    }

    function runSearch(keyword) {
        const k = (keyword || '').trim();
        if(!k) { showHome(); return; }

        const kl = k.toLowerCase();
        const results = [];
        for(const r of SEARCH_INDEX) {
            if(!r.lc) r.lc = (r.title + '\n' + r.text).toLowerCase();
            if(r.lc.includes(kl)) results.push(r);
        }
        renderSearchResults(k, results);
    }

    // ----------------------------
    // 이벤트
    // ----------------------------
    // 기존 에러 표시 영역을 홈 화면에서 재사용하기 위해 HTML 저장
    window.__OP_LOAD_ERRORS_HTML__ = (typeof errorContainer !== 'undefined' && errorContainer)
        ? errorContainer.innerHTML
        : '';

    searchInput.addEventListener('input', (e) => {
        runSearch(e.target.value);
    });

    // 초기 렌더
    renderNav(DATABASE);
    buildSearchIndex();
    showHome();

</script>
</body>
</html>
